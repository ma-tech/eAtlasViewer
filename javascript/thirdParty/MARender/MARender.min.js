MARenderMode={BASIC:0,WIREFRAME:1,LAMBERT:2,PHONG:3,EMISSIVE:4,POINT:5,SECTION:6},MARenderItem=function(){this.name=void 0,this.path=void 0,this.color=0,this.transparent=!1,this.opacity=1,this.mode=MARenderMode.PHONG,this.vertices=void 0,this.texture=void 0},MARenderer=function(win,con){var self=this;this.type="MARenderer",Object.defineProperty(self,"version",{value:"1.2.0",writable:!1}),this.win=win,this.con=con,this.scene,this.ambLight,this.dirLight,this.pntLight,this.camera,this.controls,this.renderer,this.animCount=0,this.pointSize=2,this.mousePos=new THREE.Vector2(0,0),this.nearPlane=1,this.farPlane=1e4,this.setCamOnLoad=!0,this.setHomeOnLoad=!0,this.cameraPos=new THREE.Vector3(0,0,1e4),this.center=new THREE.Vector3(0,0,0),this.homeUp=new THREE.Vector3(0,0,1),this.homePos=new THREE.Vector3(0,0,0),this.eventHandler=new THREE.EventDispatcher,THREE.ImageUtils.crossOrigin="",this.init=function(){this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(25,this.win.innerWidth/this.win.innerHeight,this.nearPlane,this.farPlane),this.camera.updateProjectionMatrix(),this.controls=new THREE.TrackballControls(this.camera),this.controls.panSpeed=.3,this.controls.dynamicDampingFactor=.7,this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(this.win.innerWidth,this.win.innerHeight),this.con.appendChild(this.renderer.domElement),this.scene.add(this.camera),this.ambLight=new THREE.AmbientLight(7829367),this.dirLight=new THREE.DirectionalLight(7829367),this.dirLight.position.set(0,0,1),this.pntLight=new THREE.PointLight(3355443,1,1e4),this.pntLight.position.set(0,.5,0),this.scene.add(this.pntLight),this.camera.add(this.ambLight),this.camera.add(this.dirLight),this.raycaster=new THREE.Raycaster,self.win.addEventListener("mousemove",self._trackMouse,!1),self.win.addEventListener("keypress",self._keyPressed,!1),self.win.addEventListener("resize",self._windowResize,!1)},this.addModel=function(gProp){var loader,itm=this._makeRenderItem(gProp);if(itm)switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:if(itm.path){var ext=itm.path.split(".").pop();"stl"===ext?loader=new THREE.STLLoader:"vtk"===ext?loader=new THREE.VTKLoader:console.log("MARenderer.addModel() unknown file type: "+ext),loader.load(itm.path,function(geom){var mat=self._makeMaterial(itm);if(mat){switch(Number(itm.mode)){case MARenderMode.POINT:var pcld=new THREE.PointCloud(geom,mat);pcld.name=itm.name,pcld.sortParticles=!0,self.scene.add(pcld);break;default:var mesh=new THREE.Mesh(geom,mat);mesh.name=itm.name,self.scene.add(mesh)}self.setCamOnLoad&&(self._computeCenter(),self.setCamera()),self.setHomeOnLoad&&self.setHome(),self.makeLive()}},function(){},function(){console.log("MARenderer.addModel() geometry load failed: "+itm.path)})}break;case MARenderMode.SECTION:itm.texture&&THREE.ImageUtils.loadTexture(itm.texture,THREE.UVMapping,function(tex){var geom=self.makeSectionGeometry(itm.vertices),mat=self._makeMaterial(itm);tex.flipY=!1,tex.minFilter=THREE.LinearFilter,tex.needsUpdate=!0,mat.map=tex;var pln=new THREE.Mesh(geom,mat);pln.name=itm.name,self.scene.add(pln),self.makeLive()},function(){console.log("MARenderer.addModel() texture load failed: "+itm.texture)})}},this.updateModel=function(gProp){if(gProp.name){var name=gProp.name,obj=this.scene.getObjectByName(name,!0);obj&&this._updateObj(obj,gProp)}this.render()},this.makeSectionGeometry=function(vertices){var geom=new THREE.Geometry;return vertices?geom.vertices=vertices.slice(0):geom.vertices=[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0)],geom.faces=[new THREE.Face3(0,1,2),new THREE.Face3(2,3,0)],geom.faceVertexUvs[0]=[[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)],[new THREE.Vector2(1,1),new THREE.Vector2(0,1),new THREE.Vector2(0,0)]],geom.computeFaceNormals(),geom.computeBoundingBox(),geom},this.setCamera=function(cen,near,far,pos){cen||near||far||pos?(this.setCamOnLoad=!1,cen&&this.center.copy(cen),near&&(this.nearPlane=near),far&&(this.farPlane=far),pos&&this.cameraPos.copy(pos)):this._computeCenter(),this.camera.near=this.nearPlane,this.camera.far=this.farPlane,this.camera.updateProjectionMatrix(),this.camera.position.copy(this.cameraPos)},this.setHome=function(pos,up){(pos||up)&&(this.setHomeOnLoad=!1),void 0===pos&&(pos=this.controls.object.position.clone()),void 0===up&&(up=this.controls.object.up.clone()),this.homeUp.copy(up),this.homePos.copy(pos),this.goHome()},this.goHome=function(){this.controls.up0.copy(this.homeUp),this.controls.position0.copy(this.homePos),this.controls.target0.copy(this.center),this.controls.reset()},this.removeModel=function(name){var obj=this.scene.getObjectByName(name,!0);obj&&(this.scene.remove(obj),obj.material&&obj.material.dispose(),obj.geometry&&obj.geometry.dispose(),this.render())},this.getChildren=function(){return this.scene.children},this.opacityIncrement=function(inc){for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];if(child&&"Mesh"===child.type&&child.material&&child.material.transparent&&void 0!=child.material.opacity){var op=child.material.opacity,tr=child.material.transparent;inc>0?.01>op?op=1/64:op*=2:op/=2,child.visible=!0,this._setMaterialOpacity(child.material,tr,op),child.material.needsUpdate=!0,this.render()}}},this.pointSizeSet=function(sz){void 0===sz&&(sz=this.pointSize);for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];child&&"PointCloud"===child.type&&child.material&&child.material.size&&(child.material.size=sz,child.material.needsUpdate=!0,this.render())}this.pointSize=sz},this.pointSizeIncrement=function(inc){for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];child&&"PointCloud"===child.type&&child.material&&child.material.size&&(child.material.size+=inc,child.material.size>99.9?child.material.size=99.9:child.material.size<.1&&(child.material.size=.1),child.material.needsUpdate=!0,this.render())}},this.render=function(){this.renderer.render(self.scene,self.camera)},this.animate=function(){var aid=self.win.requestAnimationFrame(self.animate);self.controls.update(),self.render(),++self.animCount>400&&self.win.cancelAnimationFrame(aid)},this.makeLive=function(){var count=this.animCount;this.animCount=0,count>200&&this.animate()},this.addEventListener=function(type,listener){this.eventHandler.addEventListener(type,listener)},this.removeEventListener=function(type,listener){this.eventHandler.removeEventListener(type,listener)},this.getIIP3DBBVertices=function(url,vsz){var prmX=[0,1,1,0],prmY=[0,0,1,1],max=new THREE.Vector2,vtx=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],req=new XMLHttpRequest;if(req.open("GET",url+"&OBJ=Wlz-true-voxel-size",!1),req.send(null),req.open("GET",url+"&OBJ=Max-size",!1),req.send(null),200===req.status){var rsp=req.responseText.split(":")[1].split(" ");max.x=rsp[0]-1,max.y=rsp[1]-1}for(var idx=0;4>idx;++idx)if(req.open("GET",url+"&PRL=-1,"+prmX[idx]*max.x+","+prmY[idx]*max.y+"&OBJ=Wlz-coordinate-3D",!1),req.send(null),200===req.status){var rsp=req.responseText.split(":")[1].split(" ");vtx[idx].set(rsp[0]*vsz.x,rsp[1]*vsz.y,rsp[2]*vsz.z)}return vtx},this._setMaterialOpacity=function(mat,tr,op){mat&&tr&&(.01>op?(mat.opacity=0,mat.visible=!1):(op>1&&(op=1),.51>op?mat.depthWrite=!1:mat.depthWrite=!0,mat.opacity=op,mat.visible=!0),this.render())},this._updateObj=function(obj,gProp){var itm=new MARenderItem;if(itm)if(itm.name=name,gProp.color?itm.color=gProp.color:obj.material&&obj.material.color&&(itm.color=obj.material.color),gProp.opacity?itm.opacity=gProp.opacity:obj.material&&obj.material.opacity&&(itm.opacity=obj.material.opacity),gProp.transparent?itm.transparent=gProp.transparent:obj.material&&obj.material.transparent&&(itm.transparent=obj.material.transparent),gProp.texture&&(itm.texture=gProp.texture.slice(0)),gProp.vertices&&(itm.vertices=gProp.vertices.slice(0)),gProp.mode){var mode=this._checkRenderMode(gProp.mode);mode&&(itm.mode=mode)}else"PointCloud"===obj.type&&(itm.mode=MARenderMode.POINT);switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:var mat=this._makeMaterial(itm),oldmat=obj.material;obj.material=mat,oldmat&&oldmat.dispose();break;case MARenderMode.SECTION:itm.texture&&THREE.ImageUtils.loadTexture(itm.texture,THREE.UVMapping,function(tex){var oldgeom=obj.geometry,oldtex=obj.material.map,geom=self.makeSectionGeometry(itm.vertices);tex.flipY=!1,tex.minFilter=THREE.LinearFilter,tex.needsUpdate=!0,obj.material.map=tex,obj.geometry=geom,oldtex.dispose(),oldgeom.dispose(),self.makeLive()},function(){console.log("MARenderer.updateObj() texture load failed: "+itm.texture)})}},this._updateAllMesh=function(gProp){for(var i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];child&&"Mesh"===child.type&&child.material&&!child.material.map&&(this._updateObj(child,gProp),this.render())}},this._makeRenderItem=function(gProp){var ok=!0,itm=new MARenderItem;for(var p in gProp)switch(p){case"name":case"path":itm[p]=gProp[p];break;case"color":case"opacity":itm[p]=Number(gProp[p]);break;case"transparent":itm[p]=Boolean(gProp[p]);break;case"mode":var mode=this._checkRenderMode(gProp[p]);mode&&(itm[p]=mode);break;case"vertices":itm[p]=gProp[p].slice(0);break;case"texture":itm[p]=gProp[p].slice(0);break;default:ok=!1,console.log("MARenderer._makeRenderItem() unknown property: "+p)}return ok||(itm=void 0),itm},this._checkRenderMode=function(gMode){var rMode=void 0;if(gMode)switch(Number(gMode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:case MARenderMode.SECTION:rMode=gMode;break;default:console.log("MARenderer: Unknown mode: "+gMode)}return rMode},this._makeMaterial=function(itm){var mat,sProp={};switch(itm.mode){case MARenderMode.BASIC:sProp.color=itm.color,sProp.wiretrame=!1,mat=new THREE.MeshBasicMaterial(sProp);break;case MARenderMode.WIREFRAME:sProp.color=itm.color,sProp.wireframe=!0,sProp.wireframeLinewidth=1,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.LAMBERT:sProp.color=itm.color,sProp.wireframe=!1,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.PHONG:sProp.color=itm.color,sProp.specular=1118481,sProp.wireframe=!1,sProp.emissive=0,sProp.shininess=25,sProp.transparent=itm.transparent,this._setMaterialOpacity(sProp,itm.transparent,itm.opacity),mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.EMISSIVE:sProp.color=itm.color,sProp.specular=7829367,sProp.wireframe=!1,sProp.opacity=itm.opacity,sProp.emissive=itm.color,sProp.transparent=itm.transparent,sProp.shininess=15,mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.POINT:sProp.color=itm.color,sProp.wireframe=!1,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,sProp.size=this.pointSize,sProp.blending=THREE.AdditiveBlending,sProp.alphaTest=.5,sProp.map=THREE.ImageUtils.loadTexture("textures/particle8.png"),mat=new THREE.PointCloudMaterial(sProp);break;case MARenderMode.SECTION:sProp.color=itm.color,sProp.wireframe=!1,sProp.side=THREE.DoubleSide,sProp.opacity=itm.opacity,mat=new THREE.MeshBasicMaterial(sProp)}return mat},this._computeCenter=function(){for(var n=0,box=new THREE.Box3,i=0,l=this.scene.children.length;l>i;i++){var child=this.scene.children[i];if(child&&("Mesh"===child.type||"PointCloud"===child.type)){++n;var b=new THREE.Box3;b.setFromObject(child),b.min.add(child.position),b.max.add(child.position),1==n?box.copy(b):box.union(b)}}if(n>0){var d,min,max,dMax;min=box.min.x,max=box.max.x,dMax=box.max.x-box.min.x,d=box.max.y-box.min.y,d>dMax&&(dMax=d),min>box.min.y&&(min=box.min.y),max<box.max.y&&(max=box.max.y),d=box.max.z-box.min.z,d>dMax&&(dMax=d),min>box.min.z&&(min=box.min.z),max<box.max.z&&(max=box.max.z),this.center.copy(box.center()),this.nearPlane=.2>min?.1:.5*min,this.farPlane=1>max?10:10*max,this.cameraPos.set(0,0,this.center.z+4*dMax)}},this._testCode=function(){console.log("ren.version = "+self.version),console.log("ren.setCamera(new THREE.Vector3("+self.center.x+", "+self.center.y+", "+self.center.z+"), "+self.nearPlane+", "+self.farPlane+", new THREE.Vector3("+self.camera.position.x+", "+self.camera.position.y+", "+self.camera.position.z+"));\nren.setHome(new THREE.Vector3("+self.controls.object.position.x+", "+self.controls.object.position.y+", "+self.controls.object.position.z+"), new THREE.Vector3("+self.camera.up.x+", "+self.camera.up.y+", "+self.camera.up.z+"));")},this._pick=function(){var pos=this.mousePos;self.raycaster.setFromCamera(pos,self.camera);var isct=self.raycaster.intersectObjects(self.scene.children,!1);isct.length>0&&self.eventHandler.dispatchEvent({type:"pick",hitlist:isct})},this._trackMouse=function(e){self.mousePos.x=e.clientX/self.win.innerWidth*2-1,self.mousePos.y=2*-(e.clientY/self.win.innerHeight)+1,self.makeLive()},this._keyPressed=function(e){switch(e.charCode){case 33:self._testCode();break;case 60:self.opacityIncrement(-1);break;case 62:self.opacityIncrement(1);break;case 63:self._pick();break;case 67:self.setCamera(),self.goHome();break;case 72:self.setHome();break;case 104:self.goHome();break;case 112:self.pointSizeIncrement(.1);break;case 113:self.pointSizeIncrement(-.1);break;case 115:self._updateAllMesh({mode:MARenderMode.PHONG});break;case 119:self._updateAllMesh({mode:MARenderMode.WIREFRAME})}console.log("MARender: charCode = "+e.charCode)},this._windowResize=function(){self.camera.aspect=self.win.innerWidth/self.win.innerHeight,self.camera.updateProjectionMatrix(),self.renderer.setSize(self.win.innerWidth,self.win.innerHeight),self.controls.handleResize(),self.makeLive()}};
